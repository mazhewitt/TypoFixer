name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-and-release:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo index
      uses: actions/cache@v3
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache target directory
      uses: actions/cache@v3
      with:
        path: target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Build TypoFixer
      run: cargo build --release
    
    - name: Debug - List target contents
      run: |
        echo "Contents of target/release:"
        ls -la target/release/
        echo "Looking for typo-fixer binary:"
        find target -name "typo-fixer" -type f || echo "Binary not found"
    
    - name: Create App Bundle
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        SKIP_BUILD=true VERSION=$VERSION ./build.sh
    
    - name: Create DMG
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        APP_NAME="TypoFixer"
        DMG_NAME="$APP_NAME-v$VERSION"
        APP_BUNDLE="target/release/$APP_NAME.app"
        
        # Check if app bundle exists
        if [ ! -d "$APP_BUNDLE" ]; then
          echo "Error: App bundle not found at $APP_BUNDLE"
          ls -la target/release/
          exit 1
        fi
        
        # Create temporary dmg directory
        DMG_DIR=$(mktemp -d)
        cp -R "$APP_BUNDLE" "$DMG_DIR/"
        ln -s /Applications "$DMG_DIR/Applications"
        
        # Create DMG
        hdiutil create -volname "$APP_NAME v$VERSION" -srcfolder "$DMG_DIR" -ov -format UDZO "$DMG_NAME.dmg"
        rm -rf "$DMG_DIR"
    
    - name: Create ZIP
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        APP_NAME="TypoFixer"
        ZIP_NAME="$APP_NAME-v$VERSION"
        APP_BUNDLE="target/release/$APP_NAME.app"
        
        # Check if app bundle exists
        if [ ! -d "$APP_BUNDLE" ]; then
          echo "Error: App bundle not found at $APP_BUNDLE"
          ls -la target/release/
          exit 1
        fi
        
        cd target/release
        zip -r "../../$ZIP_NAME.zip" "$APP_NAME.app"
        cd ../..
    
    - name: Create Release Notes
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        cat > RELEASE_NOTES.md << EOF
        # TypoFixer v$VERSION
        
        ## Features
        - Global hotkey (Cmd+Option+S) for instant text correction
        - LLM-powered spell and grammar checking via Ollama
        - Robust fallback methods for compatibility with all macOS applications
        - Menu bar integration for easy access
        - Smart text extraction and correction
        
        ## Installation
        1. Download the DMG or ZIP file
        2. Move TypoFixer.app to Applications
        3. Grant accessibility permissions when prompted
        4. Install and run Ollama with a language model
        
        ## Requirements
        - macOS 10.15+
        - Ollama with language model (recommended: llama3.2:1b)
        - Accessibility permissions
        
        Built on $(date +"%Y-%m-%d")
        EOF
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          TypoFixer-v*.dmg
          TypoFixer-v*.zip
        body_path: RELEASE_NOTES.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
